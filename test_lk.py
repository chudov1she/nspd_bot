"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞.
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python test_lk.py
"""
import asyncio
import os
from loguru import logger
from bot.services.rosreestr_lk import RosreestrLKClient


async def main():
    """–¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è."""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ LLM –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∫–∞–ø—á–∏
    use_llm = os.getenv("USE_LLM_CAPTCHA", "false").lower() in ("true", "1", "yes")
    
    if use_llm:
        logger.info("ü§ñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ LLM –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∫–∞–ø—á–∏")
    else:
        logger.info("üîç –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Tesseract –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∫–∞–ø—á–∏")
    
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Å–µ—Ä–≤–∏—Å–∞ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞...")
    
    # –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä –¥–ª—è —Ç–µ—Å—Ç–∞
    cadastral_number = "78:42:0018329:12213"
    
    client = RosreestrLKClient(use_llm_for_captcha=use_llm)
    
    try:
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞
        logger.info("–û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞...")
        success = await client.open_lk_page()
        
        if success:
            logger.info("‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç–∞!")
            
            # –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
            logger.info("–ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ñ–æ—Ä–º–µ –ø–æ–∏—Å–∫–∞...")
            await client.scroll_to_form()
            logger.info("‚úÖ –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!")
            
            # –ü–æ–ª—É—á–∞–µ–º –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ–º –∫–∞–ø—á—É
            logger.info("–ü–æ–ª—É—á–µ–Ω–∏–µ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–∞–ø—á–∏...")
            try:
                captcha_path, captcha_text = await client.get_and_recognize_captcha()
                
                if captcha_path:
                    logger.info(f"‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–ø—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {captcha_path}")
                    
                    if captcha_text:
                        logger.info(f"‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–∞–ø—á–∏: {captcha_text}")
                        
                        # –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –∫–∞–ø—á–∏
                        logger.info("–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª—è –∫–∞–ø—á–∏...")
                        await client.fill_captcha(captcha_text)
                        logger.info("‚úÖ –ü–æ–ª–µ –∫–∞–ø—á–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ!")
                    else:
                        logger.warning("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–µ–∫—Å—Ç –∫–∞–ø—á–∏")
                else:
                    logger.warning("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–ø—á–∏")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∫–∞–ø—á–µ–π: {e}")
                logger.warning("   –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–ø—á–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ, –Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å")
            
            # –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞
            logger.info(f"–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª—è –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞: {cadastral_number}")
            try:
                await client.fill_cadastral_number(cadastral_number)
                logger.info("‚úÖ –ü–æ–ª–µ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ!")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–æ–ª—è –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞: {e}")
            
            # –ö–ª–∏–∫–∞–µ–º –ø–æ –∫–Ω–æ–ø–∫–µ –ø–æ–∏—Å–∫–∞
            logger.info("–ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –ø–æ–∏—Å–∫–∞...")
            try:
                await client.click_search_button()
                logger.info("‚úÖ –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ –Ω–∞–∂–∞—Ç–∞!")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –∫–Ω–æ–ø–∫–µ –ø–æ–∏—Å–∫–∞: {e}")
            
            # –ñ–¥–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
            logger.info("–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞...")
            try:
                results_found = await client.wait_for_search_results()
                if results_found:
                    logger.info("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!")
                    
                    # –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ç–∞–±–ª–∏—Ü–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                    logger.info("–ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...")
                    await client.scroll_to_results_table()
                    logger.info("‚úÖ –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!")
                    
                    # –ö–ª–∏–∫–∞–µ–º –ø–æ –ø–µ—Ä–≤–æ–π –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–µ
                    logger.info("–ü–æ–∏—Å–∫ –∏ –∫–ª–∏–∫ –ø–æ –ø–µ—Ä–≤–æ–π —Å—Å—ã–ª–∫–µ...")
                    clicked = await client.click_first_result()
                    if clicked:
                        logger.info("‚úÖ –ö–ª–∏–∫ –ø–æ –ø–µ—Ä–≤–æ–π —Å—Å—ã–ª–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω!")
                        
                        # –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–±—ä–µ–∫—Ç–∞
                        logger.info("–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–±—ä–µ–∫—Ç–∞...")
                        card_loaded = await client.wait_for_object_card()
                        if card_loaded:
                            logger.info("‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±—ä–µ–∫—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!")
                            
                            # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–∞–≤–∞—Ö –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö
                            logger.info("–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∞–≤–∞—Ö –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö...")
                            try:
                                rights_data = await client.extract_rights_and_restrictions()
                                
                                if rights_data:
                                    logger.info(f"‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ {len(rights_data)} –∑–∞–ø–∏—Å–µ–π –æ –ø—Ä–∞–≤–∞—Ö –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö")
                                    # –í—ã–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã
                                    client.print_rights_table(rights_data)
                                else:
                                    logger.warning("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –æ –ø—Ä–∞–≤–∞—Ö –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
                            except Exception as e:
                                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
                        else:
                            logger.warning("‚ö†Ô∏è –ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±—ä–µ–∫—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å")
                    else:
                        logger.warning("‚ö†Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞")
                else:
                    logger.warning("‚ö†Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –Ω–µ –ø–æ—è–≤–∏–ª–∏—Å—å")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞: {e}")
            
            logger.info("–ë—Ä–∞—É–∑–µ—Ä –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞...")
            
            # –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
            await asyncio.sleep(10)
            
            logger.info("–ó–∞–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞...")
        else:
            logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É")
            
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
    finally:
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä
        await client.close()
        logger.info("‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω")


if __name__ == "__main__":
    asyncio.run(main())
